---
title: "zillow"
output: html_document
---
exploratory analysis
```{r,echo=FALSE,message=FALSE,warning=FALSE}
library(data.table)
library(dplyr)
library(htmltools)
library(ggplot2)
library(stringr)
library(DT)
library(tidyr)
library(corrplot)
library(leaflet)
library(lubridate)
setwd( "/Users/yeyazheng/Desktop/327")
transactions=fread("train_2016_v2.csv")
properties=fread("properties_2016.csv")
# set key of both sets to parcelid
setkey(transactions, parcelid)
setkey(properties, parcelid)
transactions[,transactiondate:=as.Date(transactiondate)]
transactions[,transactiondateYYYYMM:=format(transactiondate, "%Y-%m")]

properties [,`:=`(taxdelinquencyflag =ifelse(taxdelinquencyflag=="Y",1,0), fireplaceflag =ifelse(fireplaceflag=="Y",1,0), hashottuborspa = ifelse(hashottuborspa=="Y",1,0))]

# perform the join using data.table
dtrain <- properties[transactions]

dtrain[, 
       list(label=HTML(
           paste(sep="<br>",
                 paste("Bedrooms:", bedroomcnt),
                 paste("Bathrooms:", bathroomcnt),
                 paste("Total area:", finishedsquarefeet15)))), 
       list(longitude, latitude)] %>%
    leaflet() %>%
    addTiles() %>%
    addCircleMarkers(
    lat =  ~ latitude / 10e5,
    lng =  ~ longitude / 10e5,
    label = ~label,
    clusterOptions = markerClusterOptions()
    )
zip_error=dtrain[, list(n=.N, mean_error=mean(logerror), st_dev_error=sd(logerror)), by='regionidzip']
#96951 96207 96323 97331 error huge!

missing_values <- dtrain %>% summarize_each(funs(sum(is.na(.))/n()))

missing_values <- gather(missing_values, key="feature", value="missing_pct")
missing_values %>% 
  ggplot(aes(x=reorder(feature,-missing_pct),y=missing_pct)) +
  geom_bar(stat="identity",fill="red")+
  coord_flip()+theme_bw()+ggtitle("Missing Pattern")
bad_features=filter(missing_values,missing_pct>=0.1)
dtrain %>% 
  group_by(transactiondate) %>% count() %>% 
  ggplot(aes(x=transactiondate,y=n)) +
  geom_bar(stat="identity", fill="red")+ggtitle("# of Transactions by Day")

dtrain %>% 
  group_by(transactiondate) %>% summarise(med_error=abs(mean(logerror,na.rm=T)))%>% 
  ggplot(aes(x=transactiondate,y=med_error)) +
  geom_bar(stat="identity", fill="red")+ggtitle("Absolute Mean Logerror by Date")


dtrain %>% 
  group_by(yearbuilt) %>% summarise(med_error=abs(mean(logerror,na.rm=T)))%>% 
  ggplot(aes(x=yearbuilt,y=med_error)) +geom_point(color='grey', alpha=0.8) + 
    geom_smooth(color='steelblue') + 
    labs(y='Mean log error', title='Mean absolute log error by year built')


ggplot(data=dtrain, aes(x=as.factor(bedroomcnt), y=abs(logerror))) + 
    geom_jitter(alpha=0.3, color='lightgrey') +
    geom_boxplot(outlier.color=NA, color='steelblue') + 
    labs(x='Number of bedrooms', title='Distribution of absolute log error by bedroom count')

ggplot(data=dtrain, aes(x=as.factor(bathroomcnt), y=abs(logerror))) + 
    geom_jitter(alpha=0.3, color='lightgrey') +
    geom_boxplot(outlier.color=NA, color='steelblue') + 
    labs(x='Number of bathroomcnt', title='Distribution of absolute log error by bathroom count')

ggplot(data=dtrain, aes(x=as.factor(fireplacecnt), y=abs(logerror))) + 
    geom_jitter(alpha=0.3, color='lightgrey') +
    geom_boxplot(outlier.color=NA, color='steelblue')+labs(x='Number of fireplace', title='Distribution of absolute log error by fireplace count')


ggplot(data=dtrain, aes(x=as.factor(garagecarcnt), y=abs(logerror))) + 
    geom_jitter(alpha=0.3, color='lightgrey') +
    geom_boxplot(outlier.color=NA, color='steelblue')+labs(x='Number of Garage', title='Distribution of absolute log error by garage count')

ggplot(data=dtrain, aes(x=as.factor(unitcnt), y=abs(logerror))) + 
    geom_jitter(alpha=0.3, color='lightgrey') +
    geom_boxplot(outlier.color=NA, color='steelblue')+labs(x='Number of Units', title='Distribution of absolute log error by Unit count')


  
dtrain[,`:=`(poolcnt=ifelse(is.na(poolcnt),0,poolcnt),pooltypeid10=ifelse(is.na(pooltypeid10),0,pooltypeid10),pooltypeid2=ifelse(is.na(pooltypeid2),0,pooltypeid2),pooltypeid7=ifelse(is.na(pooltypeid7),0,pooltypeid7))]

dtrain[,abs_logerror:=abs(logerror)]


house_features=c("airconditioningtypeid","architecturalstyletypeid",'basementsqft','bathroomcnt','bedroomcnt','buildingqualitytypeid','buildingclasstypeid','calculatedbathnbr','decktypeid','threequarterbathnbr','finishedfloor1squarefeet','calculatedfinishedsquarefeet','finishedsquarefeet6','finishedsquarefeet12','finishedsquarefeet13','finishedsquarefeet15','finishedsquarefeet50','fireplacecnt','fireplaceflag','fullbathcnt','garagecarcnt','garagetotalsqft','hashottuborspa','heatingorsystemtypeid','lotsizesquarefeet','numberofstories','poolcnt','poolsizesum','pooltypeid10','pooltypeid2','pooltypeid7','roomcnt','storytypeid','typeconstructiontypeid','unitcnt','yardbuildingsqft17','yardbuildingsqft26','yearbuilt',"logerror","abs_logerror")
geo_features=c('latitude','longitude','regionidcounty','regionidcity','regionidzip','regionidneighborhood',"logerror","abs_logerror")
  tax_features=c('taxvaluedollarcnt','structuretaxvaluedollarcnt','landtaxvaluedollarcnt','taxamount','assessmentyear','taxdelinquencyflag','taxdelinquencyyear',"logerror","abs_logerror")
  corrplot(cor(dtrain[, ..house_features], use='pairwise.complete.obs'), type='lower')
  corrplot(cor(dtrain[, ..geo_features], use='pairwise.complete.obs'), type='lower')
  corrplot(cor(dtrain[, ..tax_features], use='pairwise.complete.obs'), type='lower')

 ```