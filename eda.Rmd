---
title: "exploratory analysis"
author: "Yeya"
output: html_document
---

```{r,echo=FALSE,message=FALSE,warning=FALSE,results='hide'}
library(data.table)
library(dplyr)
library(htmltools)
library(ggplot2)
library(stringr)
library(DT)
library(tidyr)
library(corrplot)
library(leaflet)
library(lubridate)
setwd( "/Users/yeyazheng/Desktop/327")
transactions=fread("train_2016_v2.csv")
properties=fread("properties_2016.csv")
# set key of both sets to parcelid
setkey(transactions, parcelid)
setkey(properties, parcelid)
transactions[,transactiondate:=as.Date(transactiondate)]
transactions[,transactiondateYYYYMM:=format(transactiondate, "%Y-%m")]

properties [,`:=`(taxdelinquencyflag =ifelse(taxdelinquencyflag=="Y",1,0), fireplaceflag =ifelse(fireplaceflag=="Y",1,0), hashottuborspa = ifelse(hashottuborspa=="Y",1,0))]

dtrain <- properties[transactions]

```

Visualize properties on map. 

```{r,echo=FALSE,message=FALSE,warning=FALSE}
dtrain[, 
       list(label=HTML(
           paste(sep="<br>",
                 paste("Bedrooms:", bedroomcnt),
                 paste("Bathrooms:", bathroomcnt),
                 paste("Total area:", finishedsquarefeet15)))), 
       list(longitude, latitude)] %>%
    leaflet() %>%
    addTiles() %>%
    addCircleMarkers(
    lat =  ~ latitude / 10e5,
    lng =  ~ longitude / 10e5,
    label = ~label,
    clusterOptions = markerClusterOptions()
    )
```

Examine the missing pattern 

```{r,echo=FALSE,message=FALSE,warning=FALSE}
missing_values <- dtrain %>% summarize_each(funs(sum(is.na(.))/n()))

missing_values <- gather(missing_values, key="feature", value="missing_pct")
missing_values %>% 
  ggplot(aes(x=reorder(feature,-missing_pct),y=missing_pct)) +
  geom_bar(stat="identity",fill="red")+
  coord_flip()+theme_bw()+ggtitle("Missing Pattern")
```

Lots of features contain high percentage of NAs. Need to deal with these features later. 

Examine the distribution of log error 

```{r,echo=FALSE,message=FALSE,warning=FALSE}
plot(density(dtrain$logerror),type="l")

cat("Log error are normally distributed. For those properties with log error 2 SDs above the mean, I labeled them as overestimated outliers, for those properties with log error 2 SDs below the mean, I labeled them as underestimated outliers. I examined the latitude and longitude distributions of these outliers. ")

ub=mean(dtrain$logerror)+2*sd(dtrain$logerror)
lb=mean(dtrain$logerror)-2*sd(dtrain$logerror)

tmp=dtrain[,type:=ifelse(logerror>ub,2,ifelse(logerror<lb,1,0))]


ggplot(data=tmp,aes(x=latitude,y=longitude,group=as.factor(type),colour=as.factor(type)))+geom_point()

```

Examine distribution of # of transactions by day and absolute mean logerror by day.  

```{r,echo=FALSE,message=FALSE,warning=FALSE}
dtrain %>% 
  group_by(transactiondate) %>% count() %>% 
  ggplot(aes(x=transactiondate,y=n)) +
  geom_bar(stat="identity", fill="red")+ggtitle("# of Transactions by Day")

dtrain %>% 
  group_by(transactiondate) %>% summarise(med_error=abs(mean(logerror,na.rm=T)))%>% 
  ggplot(aes(x=transactiondate,y=med_error)) +
  geom_bar(stat="identity", fill="red")+ggtitle("Absolute Mean Logerror by Date")
```

Examine the variation in log error across various discrete and continuous features. Found some interesting pattern with yearbuilt, number of bedrooms, number of bathrooms, fireplacecnt, garagecarcnt, Number of Units,propertylandusetypeid

```{r,echo=FALSE,message=FALSE,warning=FALSE}

dtrain %>% 
  group_by(yearbuilt) %>% summarise(med_error=abs(mean(logerror,na.rm=T)))%>% 
  ggplot(aes(x=yearbuilt,y=med_error)) +geom_point(color='grey', alpha=0.8) + 
    geom_smooth(color='steelblue') + 
    labs(y='Mean log error', title='Mean absolute log error by year built')


ggplot(data=dtrain, aes(x=as.factor(bedroomcnt), y=abs(logerror))) + 
    geom_jitter(alpha=0.3, color='lightgrey') +
    geom_boxplot(outlier.color=NA, color='steelblue') + 
    labs(x='Number of bedrooms', title='Distribution of absolute log error by bedroom count')

ggplot(data=dtrain, aes(x=as.factor(bathroomcnt), y=abs(logerror))) + 
    geom_jitter(alpha=0.3, color='lightgrey') +
    geom_boxplot(outlier.color=NA, color='steelblue') + 
    labs(x='Number of bathroomcnt', title='Distribution of absolute log error by bathroom count')

ggplot(data=dtrain, aes(x=as.factor(fireplacecnt), y=abs(logerror))) + 
    geom_jitter(alpha=0.3, color='lightgrey') +
    geom_boxplot(outlier.color=NA, color='steelblue')+labs(x='Number of fireplace', title='Distribution of absolute log error by fireplace count')


ggplot(data=dtrain, aes(x=as.factor(garagecarcnt), y=abs(logerror))) + 
    geom_jitter(alpha=0.3, color='lightgrey') +
    geom_boxplot(outlier.color=NA, color='steelblue')+labs(x='Number of Garage', title='Distribution of absolute log error by garage count')

ggplot(data=dtrain, aes(x=as.factor(unitcnt), y=abs(logerror))) + 
    geom_jitter(alpha=0.3, color='lightgrey') +
    geom_boxplot(outlier.color=NA, color='steelblue')+labs(x='Number of Units', title='Distribution of absolute log error by Unit count')


ggplot(data=dtrain, aes(x=as.factor(propertylandusetypeid), y=abs(logerror))) + geom_jitter(alpha=0.3, color='lightgrey') +
geom_boxplot(outlier.color=NA, color='steelblue')+labs(x='propertylandusetypeid', title='Distribution of absolute log error by propertylandusetypeid')

  
zip_error=dtrain[, list(n=.N, mean_error=mean(logerror), st_dev_error=sd(logerror)), by='regionidzip']
#96951 96207 96323 97331 error huge
  
```

```{r echo=FALSE,message=FALSE,warning=FALSE,results='hide'}
dtrain[,abs_logerror:=abs(logerror)]
```

I group the features into 3 groups: features related to house physical features(house_features), features related to tax (tax_features),and features related to geo-location (geo_features). I made some correlation plots to examine each feature's correlation with log error and absolute log error within each group.

```{r,echo=FALSE,message=FALSE,warning=FALSE}

house_features=c("airconditioningtypeid","architecturalstyletypeid",'basementsqft','bathroomcnt','bedroomcnt','calculatedbathnbr','threequarterbathnbr','finishedfloor1squarefeet','calculatedfinishedsquarefeet','finishedsquarefeet6','finishedsquarefeet12','finishedsquarefeet13','finishedsquarefeet15','finishedsquarefeet50','fireplacecnt','fireplaceflag','fullbathcnt','garagecarcnt','garagetotalsqft','hashottuborspa','heatingorsystemtypeid','lotsizesquarefeet','numberofstories','poolcnt','poolsizesum','pooltypeid10','pooltypeid2','pooltypeid7','roomcnt','typeconstructiontypeid','unitcnt','yardbuildingsqft17','yardbuildingsqft26','yearbuilt',"logerror","abs_logerror")
geo_features=c('latitude','longitude','regionidcounty','regionidcity','regionidzip','regionidneighborhood',"logerror","abs_logerror")
  tax_features=c('taxvaluedollarcnt','structuretaxvaluedollarcnt','landtaxvaluedollarcnt','taxamount','assessmentyear','taxdelinquencyflag','taxdelinquencyyear',"logerror","abs_logerror")
  corrplot(cor(dtrain[, ..house_features], use='pairwise.complete.obs'), type='lower')
  corrplot(cor(dtrain[, ..geo_features], use='pairwise.complete.obs'), type='lower')
  corrplot(cor(dtrain[, ..tax_features], use='pairwise.complete.obs'), type='lower')

```

No feature seems to have strong correlation with either log error or absolute log error 